<!DOCTYPE html>
<html>
<head>
    <title>Websocket client</title>
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="http://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/locale/ja.js"></script>
    <style>
    .preform {
    	white-space: pre;
    	font-family: monospace;
    }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="page-header">地震計をリアルタイム表示</h1>

        <form action="" class="form-inline" id="connectForm">
            <div class="input-append">
                <input type="text" class="input-large" value="ws://localhost:8088/echo" id="wsServer">
                <button class="btn" type="submit" id="connect">Connect</button>
                <button class="btn" disabled="disabled" id="disconnect">Disconnect</button>
            </div>
        </form>
        <form action="" id="sendForm" class="row">
        	<div class="span8">
				<button class="btn btn-primary" type="submit" id="send" disabled="disabled">Start</button>
	        	<label>データ表示範囲</label>
				<input class="input-large" type="number" id="from" value="0"/>
				～<input class="input-large" type="number" id="to" value="10"/>
	        	<label>解像度</label>
				<input class="input-large" type="number" id="steps" value="40"/>
            </div>
            <div class="span2"><span class="" id="Hz">??</span>Hz</div>
            <div class="span2"><span class="" id="buffer">??</span>Bytes</div>
        </form>
        <hr>
        
        <ul class="unstyled hide" id="log"></ul>
		<div class="graph-head" id="plotTitle"></div>
		<div class="graph" id="myDiv"></div>
        
    </div>
    
    <script>
        var trace1 = {
            x: [],
            y: [],
            name: 'x',
            mode: 'lines',
            line: {
                color: '#80CAF6',
            }
        }

        var trace2 = {
            x: [],
            y: [],
            name: 'y',
            xaxis: 'x2',
            yaxis: 'y2',
            mode: 'lines',
            line: {color: '#DF56F1'}
        };

        var trace3 = {
            x: [],
            y: [],
            name: 'z',
            xaxis: 'x3',
            yaxis: 'y3',
            mode: 'lines',
            line: {color: '#444444'}
        };

        var layout = {
            height: 800,
            xaxis: {
                type: 'date',
                domain: [0, 1],
            },
            yaxis: {domain: [0, 0.3]},
            xaxis2: {
                type: 'date',
                anchor: 'y2',
                domain: [0, 1]
            },
            yaxis2: {
                anchor: 'x2',
                domain: [0.35, 0.65]
            },
            xaxis3: {
                type: 'date',
                anchor: 'y3',
                domain: [0, 1]
            },
            yaxis3: {
                anchor: 'x3',
                domain: [0.7,1]
            },    
        }

        var data = [trace1,trace2,trace3];

        //Plotly.newPlot('myDiv', data, layout);
        
        var range = 10000;
        var timerHz = new Date();
        var cntHz = 0;
        var cntDataSize = 0;
        
        var RANGE_FROM = 0;
        var RANGE_TO = 32767
        var MAX_SIZE = RANGE_TO - RANGE_FROM;
        var STEP_SIZE = 40;
        
        function plotlabel(data){
           let pos = Math.round((STEP_SIZE-String(data).length) / 2);
           return " ".repeat(pos) + data + " ".repeat(STEP_SIZE - (pos + String(data).length) + 1);
        }
        function plot(data){
           let pos = Math.round((data - RANGE_FROM) / (MAX_SIZE / STEP_SIZE));
           if(pos < 0 || STEP_SIZE - pos < 0){
             return " ".repeat(Number(STEP_SIZE) + 1);
           }else{
             return " ".repeat(pos) + "*" + " ".repeat(STEP_SIZE - pos);
           }
        }

        $(document).ready(function() {
            var ws;

            $('#connectForm').on('submit', function() {
                if ("WebSocket" in window) {
                    ws = new WebSocket($('#wsServer').val());
                    ws.onopen = function() {
                        $('#log').append('<li><span class="badge badge-success">websocket opened</span></li>');
                        $('#wsServer').attr('disabled', 'disabled');
                        $('#connect').attr('disabled', 'disabled');
                        $('#disconnect').removeAttr('disabled');
                        $('#message').removeAttr('disabled').focus();
                        $('#send').removeAttr('disabled');
                    };

                    ws.onerror = function() {
                        $('#log').append('<li><span class="badge badge-important">websocket error</span></li>');
                    };

                    ws.onmessage = function(event) {

	                    cntDataSize = event.data.length;
	                    let lines = event.data.split('\n');
	                    let nowTime;
	                    let olderTime;
	                    for (line of lines) {
	                        if(line.length == 0) break;
		                    let list = line.split(',');
		                    time = new Date(list[0] * 1000);
		                    let data_x = list[1];
		                    let data_y = list[2];
		                    let data_z = list[3];
		                    let view_item = '<li class="preform">'
                            	+plotlabel( moment(time).format("YYYY/MM/DD HH:mm:ss.SS") ) + '|'
                            	+plot(data_x) + '|'
                            	+plot(data_y) + '|'
                            	+plot(data_z) + '|' +'</li>';
                            $('#myDiv').prepend(view_item);
		                    let update = {
		                        x:  [[time], [time], [time]],
		                        y: [[data_x],[data_y], [data_z]]
		                    };

		                    nowTime = new Date(time.getTime());
		                    olderTime = new Date(time.getTime() - range);
		                    
		                    //Plotly.extendTraces('myDiv', update, [0,1,2]);
		                    cntHz++;
	                    }
	                    var minuteView = {
	                        xaxis: {
	                            type: 'date',
	                            range: [olderTime,nowTime]
	                        },
	                        xaxis2: {
	                            anchor: 'x2',
	                            type: 'date',
	                            range: [olderTime,nowTime]
	                        },
	                        xaxis3: {
	                            anchor: 'x3',
	                            type: 'date',
	                            range: [olderTime,nowTime]
	                        }
	                    };
	                    if(new Date() - timerHz >= 1000) {
	                      console.log(cntHz);
	                      $('#Hz').html(cntHz);
	                      $('#buffer').html(cntDataSize);

	                      cntHz = 0;
	                      timerHz = new Date();
	                    }
	                    //Plotly.relayout('myDiv', minuteView);

                    };

                    ws.onclose = function() {
                        $('#log').append('<li><span class="badge badge-important">websocket closed</span></li>');
                        $('#wsServer').removeAttr('disabled');
                        $('#connect').removeAttr('disabled');
                        $('#disconnect').attr('disabled', 'disabled');
                        $('#message').attr('disabled', 'disabled');
                        $('#send').attr('disabled', 'disabled');
                    };
                } else {
                    $('#log').prepend('<li><span class="badge badge-important">WebSocket NOT supported in this browser</span></li>');
                }

                return false;
            });
            $('#sendForm').on('submit', function() {
                var message = 'start\n';
                RANGE_FROM = $('#from').val();
                RANGE_TO = $('#to').val();
                MAX_SIZE = RANGE_TO - RANGE_FROM;
                STEP_SIZE = $('#steps').val();
                ws.send(message);
                $('#log').append('<li>sended: <span class="badge">' + message + '</span></li>');
                $('#plotTitle').html('<li class="preform">'
                            	+plotlabel('time') + '|'
                            	+plotlabel('x data') + '|'
                            	+plotlabel('y data') + '|'
                            	+plotlabel('z data') + '|' +'</li>');


                return false;
            });
            $('#disconnect').on('click', function() {
                ws.close();

                return false;
            });
            
            $('#from').on('change', function() {
                RANGE_FROM = $(this).val();
                MAX_SIZE = RANGE_TO - RANGE_FROM;
                console.log("from:"+RANGE_FROM);
            });
            $('#to').on('change', function() {
                RANGE_TO = $(this).val();
                MAX_SIZE = RANGE_TO - RANGE_FROM;
                console.log("to:"+RANGE_TO);
            });
            $('#steps').on('change', function() {
                STEP_SIZE = $(this).val();
                console.log("steps:"+STEP_SIZE);
                $('#plotTitle').html('<li class="preform">'
                            	+plotlabel('time') + '|'
                            	+plotlabel('x data') + '|'
                            	+plotlabel('y data') + '|'
                            	+plotlabel('z data') + '|' +'</li>');
            });
        });
    </script>
</body>
</html>